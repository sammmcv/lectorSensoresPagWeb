<!DOCTYPE html>
<html>
<head>
    <title>Monitoreo Sensores IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Monitoreo Sensores IoT</h1>
    <table border="1" id="tabla">
        <thead>
            <tr>
                <th>Hora</th><th>CO₂</th><th>Velocidad (km/h)</th><th>Temp (°C)</th><th>dB</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <canvas id="grafica" width="600" height="200"></canvas>
    <script>
        async function cargarDatos() {
            const res = await fetch('/ultimos');
            const datos = await res.json();
            const tbody = document.getElementById('tabla').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            let labels = [], co2 = [], velocidad = [], temp = [], db = [];
            datos.reverse().forEach(row => {
                let tr = document.createElement('tr');
                row.forEach(d => {
                    let td = document.createElement('td');
                    td.innerText = d;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                labels.push(row[0].split(' ')[1]);
                co2.push(Number(row[1]));
                velocidad.push(Number(row[2]));
                temp.push(Number(row[3]));
                db.push(Number(row[4]));
            });


            // Debug: muestra arrays en consola
            // console.log("labels", labels);
            // console.log("velocidad", velocidad);

            if(window.grafica) window.grafica.destroy();
            window.grafica = new Chart(document.getElementById('grafica'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {label: 'CO₂', data: co2, borderColor: 'green', yAxisID: 'A', fill: false},
                        {label: 'Velocidad', data: velocidad, borderColor: 'blue', yAxisID: 'B', fill: false},
                        {label: 'Temp', data: temp, borderColor: 'red', yAxisID: 'C', fill: false},
                        {label: 'dB', data: db, borderColor: 'orange', yAxisID: 'D', fill: false}
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        A: {type: 'linear', position: 'left', min: 390, max: 430, title: {display: true, text: "CO₂ (ppm)"}},
                        B: {type: 'linear', position: 'right', min: 0, max: 10, title: {display: true, text: "Velocidad (km/h)"}, grid: {drawOnChartArea: false}},
                        C: {type: 'linear', position: 'left', min: 20, max: 30, title: {display: true, text: "Temp (°C)"}, grid: {drawOnChartArea: false}},
                        D: {type: 'linear', position: 'right', min: -90, max: 0, title: {display: true, text: "dB"}, grid: {drawOnChartArea: false}}
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }
        setInterval(cargarDatos, 3000);
        cargarDatos();
    </script>
</body>
</html>
