<!DOCTYPE html>
<html>
<head>
    <title>Monitoreo Sensores IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        .online { background-color: #4CAF50; }
        .offline { background-color: #f44336; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .controls button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .controls button:hover { background: #45a049; }
        .controls button.danger { background: #f44336; }
        .controls button.danger:hover { background: #da190b; }
        table { 
            margin-bottom: 30px; 
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
        }
        table th {
            background: #667eea;
            color: white;
            padding: 12px;
        }
        table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .chart-container {
            margin-bottom: 24px;
            width: 350px;
            height: 200px;
            display: inline-block;
            vertical-align: top;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        canvas {
            width: 320px !important;
            height: 140px !important;
        }
        h3 { 
            margin-bottom: 6px; 
            color: #333;
            text-align: center;
        }
        thead th { font-size: 1em; }
        td, th { text-align: center; }
        .valor-critico { background-color: #ffebee !important; color: #c62828; }
        .valor-normal { background-color: #e8f5e8 !important; color: #2e7d32; }
        .valor-advertencia { background-color: #fff3e0 !important; color: #ef6c00; }
        .stats {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå°Ô∏è Monitoreo Sensores IoT üìä</h1>
        <span id="connection-status">Conectando...</span>
        <span id="status-indicator" class="status-indicator offline"></span>
    </div>

    <div class="controls">
        <button onclick="toggleAutoRefresh()" id="refreshBtn">‚è∏Ô∏è Pausar</button>
        <button onclick="exportarDatos()">üì• Exportar CSV</button>
        <button onclick="borrarDatos()" class="danger">üóëÔ∏è Borrar Datos</button>
        <span style="margin-left: 20px;">√öltima actualizaci√≥n: <span id="lastUpdate">-</span></span>
    </div>

    <div class="stats" id="statsContainer" style="display: none;">
        <div class="stat-item">
            <div class="stat-value" id="stat-co2">-</div>
            <div class="stat-label">CO‚ÇÇ Actual (ppm)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-temp">-</div>
            <div class="stat-label">Temperatura (¬∞C)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-vel">-</div>
            <div class="stat-label">Velocidad (km/h)</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-db">-</div>
            <div class="stat-label">Ruido (dB)</div>
        </div>
    </div>

    <table border="1" id="tabla">
        <thead>
            <tr>
                <th>üïê Hora</th><th>üå± CO‚ÇÇ (ppm)</th><th>üöó Velocidad (km/h)</th><th>üå°Ô∏è Temp (¬∞C)</th><th>üîä dB</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="chart-container">
        <h3>üå± CO‚ÇÇ (ppm)</h3>
        <canvas id="grafica_co2"></canvas>
    </div>
    <div class="chart-container">
        <h3>üöó Velocidad (km/h)</h3>
        <canvas id="grafica_vel"></canvas>
    </div>
    <div class="chart-container">
        <h3>üå°Ô∏è Temperatura (¬∞C)</h3>
        <canvas id="grafica_temp"></canvas>
    </div>
    <div class="chart-container">
        <h3>üîä Nivel de Ruido (dB)</h3>
        <canvas id="grafica_db"></canvas>
    </div>

    <script>
        let chart_co2, chart_vel, chart_temp, chart_db;
        let autoRefresh = true;
        let refreshInterval;

        // Funci√≥n para convertir UTC a hora de CDMX
        function convertirAHoraCDMX(timestampUTC) {
            const fecha = new Date(timestampUTC + ' UTC');
            const options = {
                timeZone: 'America/Mexico_City',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            return fecha.toLocaleString('es-MX', options);
        }

        // Funci√≥n para clasificar valores y aplicar estilos
        function clasificarValor(valor, tipo) {
            switch(tipo) {
                case 'co2':
                    if (valor > 1000) return 'valor-critico';
                    if (valor > 600) return 'valor-advertencia';
                    return 'valor-normal';
                case 'temp':
                    if (valor < 10 || valor > 35) return 'valor-critico';
                    if (valor < 15 || valor > 30) return 'valor-advertencia';
                    return 'valor-normal';
                case 'db':
                    if (valor > 85) return 'valor-critico';
                    if (valor > 70) return 'valor-advertencia';
                    return 'valor-normal';
                case 'vel':
                    if (valor > 50) return 'valor-advertencia';
                    return 'valor-normal';
                default:
                    return 'valor-normal';
            }
        }

        // Funciones de control
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('refreshBtn');
            if (autoRefresh) {
                btn.innerHTML = '‚è∏Ô∏è Pausar';
                startAutoRefresh();
            } else {
                btn.innerHTML = '‚ñ∂Ô∏è Reanudar';
                clearInterval(refreshInterval);
            }
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(cargarDatos, 3000);
        }

        function exportarDatos() {
            window.open('/exportar', '_blank');
        }

        async function borrarDatos() {
            if (confirm('¬øEst√°s seguro de que quieres borrar todos los datos?')) {
                const response = await fetch('/borrar', { method: 'POST' });
                const result = await response.json();
                alert(result.status);
                cargarDatos();
            }
        }

        async function cargarDatos() {
            try {
                const res = await fetch('/ultimos');
                const datos = await res.json();
                
                // Actualizar indicador de conexi√≥n
                document.getElementById('connection-status').textContent = 'Conectado';
                document.getElementById('status-indicator').className = 'status-indicator online';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-MX');

                const tbody = document.getElementById('tabla').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                let labels = [], co2 = [], velocidad = [], temp = [], db = [];
                let showFake = false;

                // Si hay datos reales, pinta tabla y gr√°ficas reales
                if (datos && datos.length >= 2) {
                    // Mostrar estad√≠sticas actuales
                    document.getElementById('statsContainer').style.display = 'flex';
                    const ultimo = datos[0];
                    document.getElementById('stat-co2').textContent = Number(ultimo[1]).toFixed(1);
                    document.getElementById('stat-temp').textContent = Number(ultimo[3]).toFixed(1);
                    document.getElementById('stat-vel').textContent = Number(ultimo[2]).toFixed(1);
                    document.getElementById('stat-db').textContent = Number(ultimo[4]).toFixed(1);

                    datos.reverse().forEach(row => {
                        let tr = document.createElement('tr');
                        
                        // Convertir la hora a CDMX y mostrarla
                        const horaCDMX = convertirAHoraCDMX(row[0]);
                        
                        row.forEach((d, i) => {
                            let td = document.createElement('td');
                            if (i === 0) {
                                td.innerText = horaCDMX;
                            } else {
                                const valor = Number(d);
                                if (i === 1) {
                                    td.innerText = valor.toFixed(3);
                                    td.className = clasificarValor(valor, 'co2');
                                } else if (i === 2) {
                                    td.innerText = valor.toFixed(2);
                                    td.className = clasificarValor(valor, 'vel');
                                } else if (i === 3) {
                                    td.innerText = valor.toFixed(2);
                                    td.className = clasificarValor(valor, 'temp');
                                } else if (i === 4) {
                                    td.innerText = valor.toFixed(1);
                                    td.className = clasificarValor(valor, 'db');
                                }
                            }
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);

                        // Solo mostrar √∫ltimas 10 lecturas en gr√°ficas
                        if (labels.length < 10) {
                            labels.push(horaCDMX.split(' ')[1]);
                            co2.push(Number(row[1]));
                            velocidad.push(Number(row[2]));
                            temp.push(Number(row[3]));
                            db.push(Number(row[4]));
                        }
                    });
                } else {
                    // Datos fake si no hay reales
                    document.getElementById('statsContainer').style.display = 'none';
                    showFake = true;
                    labels = ["12:00","12:01","12:02","12:03"];
                    co2 = [400, 405, 410, 402];
                    velocidad = [0, 1, 2, 1];
                    temp = [21.9, 22.5, 23, 22.8];
                    db = [55, 58, 62, 56];
                }

                // Actualizar gr√°ficas con rangos ajustados a tus datos reales
                updateChart('co2', labels, co2, 'green', 390, 450);
                updateChart('vel', labels, velocidad, 'blue', 0, 10);
                updateChart('temp', labels, temp, 'red', 5, 25);  // Ajustado para tus temperaturas
                updateChart('db', labels, db, 'orange', 45, 75);  // Ajustado para tus dB

                if (showFake) tbody.innerHTML = '';

            } catch (error) {
                console.error('Error al cargar datos:', error);
                document.getElementById('connection-status').textContent = 'Error de conexi√≥n';
                document.getElementById('status-indicator').className = 'status-indicator offline';
            }
        }

        function updateChart(tipo, labels, data, color, min, max) {
            const canvasId = `grafica_${tipo}`;
            const chartVar = `chart_${tipo}`;
            
            if (window[chartVar]) window[chartVar].destroy();
            
            window[chartVar] = new Chart(document.getElementById(canvasId), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: tipo.toUpperCase(),
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            min: min,
                            max: max,
                            grid: { color: '#f0f0f0' }
                        },
                        x: {
                            grid: { color: '#f0f0f0' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    }
                }
            });
        }

        // Inicializar
        startAutoRefresh();
        cargarDatos();
    </script>
</body>
</html>
