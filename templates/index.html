<!DOCTYPE html>
<html>
<head>
    <title>Monitoreo Sensores IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        table { margin-bottom: 30px; }
        .chart-container {
            margin-bottom: 24px;
            width: 350px;
            height: 160px;
            display: inline-block;
            vertical-align: top;
        }
        canvas {
            width: 320px !important;
            height: 120px !important;
        }
        h3 { margin-bottom: 6px; }
        thead th { font-size: 1em; }
        td, th { text-align: center; }
    </style>
</head>
<body>
    <h1>Monitoreo Sensores IoT</h1>
    <table border="1" id="tabla">
        <thead>
            <tr>
                <th>Hora</th><th>CO₂</th><th>Velocidad (km/h)</th><th>Temp (°C)</th><th>dB</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="chart-container">
        <h3>CO₂ (ppm)</h3>
        <canvas id="grafica_co2"></canvas>
    </div>
    <div class="chart-container">
        <h3>Velocidad (km/h)</h3>
        <canvas id="grafica_vel"></canvas>
    </div>
    <div class="chart-container">
        <h3>Temp (°C)</h3>
        <canvas id="grafica_temp"></canvas>
    </div>
    <div class="chart-container">
        <h3>dB</h3>
        <canvas id="grafica_db"></canvas>
    </div>

    <script>
        let chart_co2, chart_vel, chart_temp, chart_db;

        // Función para convertir UTC a hora de CDMX
        function convertirAHoraCDMX(timestampUTC) {
            const fecha = new Date(timestampUTC + ' UTC');
            // CDMX está en UTC-6 (CST) o UTC-5 (CDT) dependiendo del horario de verano
            const options = {
                timeZone: 'America/Mexico_City',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            return fecha.toLocaleString('es-MX', options);
        }

        async function cargarDatos() {
            const res = await fetch('/ultimos');
            const datos = await res.json();
            const tbody = document.getElementById('tabla').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            let labels = [], co2 = [], velocidad = [], temp = [], db = [];
            let showFake = false;

            // Si hay datos reales, pinta tabla y gráficas reales
            if (datos && datos.length >= 2) {
                datos.reverse().forEach(row => {
                    let tr = document.createElement('tr');
                    
                    // Convertir la hora a CDMX y mostrarla
                    const horaCDMX = convertirAHoraCDMX(row[0]);
                    
                    row.forEach((d, i) => {
                        let td = document.createElement('td');
                        if (i === 0) td.innerText = horaCDMX;                     // hora convertida a CDMX
                        else if (i === 1) td.innerText = Number(d).toFixed(3);    // CO₂ con 3 decimales
                        else if (i > 1) td.innerText = Number(d).toFixed(2);      // otras columnas con 2 decimales
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);

                    // Hora real HH:MM:SS como label en las gráficas (solo la parte de tiempo)
                    labels.push(horaCDMX.split(' ')[1]);
                    co2.push(Number(row[1]));
                    velocidad.push(Number(row[2]));
                    temp.push(Number(row[3]));
                    db.push(Number(row[4]));
                });
            } else {
                // Datos fake si no hay reales
                showFake = true;
                labels = ["t1","t2","t3","t4"];
                co2 = [400, 405, 410, 402];
                velocidad = [0, 1, 2, 1];
                temp = [21.9, 22.5, 23, 22.8];
                db = [-80, -40, -60, -30];
            }

            // --- Gráfica CO₂ (más precisión) ---
            if (chart_co2) chart_co2.destroy();
            chart_co2 = new Chart(document.getElementById('grafica_co2'), {
                type: 'line',
                data: { labels: labels, datasets: [{
                    label: 'CO₂',
                    data: co2,
                    borderColor: 'green',
                    fill: false,
                    pointRadius: 3
                }] },
                options: {
                    scales: { y: { min: 390, max: 430, title: {display:true,text:"CO₂ (ppm)"}}},
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: ctx => `CO₂: ${ctx.parsed.y.toFixed(3)} ppm`  // más precisión aquí
                            }
                        }
                    }
                }
            });
            // --- Velocidad ---
            if (chart_vel) chart_vel.destroy();
            chart_vel = new Chart(document.getElementById('grafica_vel'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'Velocidad', data: velocidad, borderColor: 'blue', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: 0, max: 10, title: {display:true,text:"Velocidad (km/h)"}}},
                    plugins: { legend: {display: false} }
                }
            });
            // --- Temp ---
            if (chart_temp) chart_temp.destroy();
            chart_temp = new Chart(document.getElementById('grafica_temp'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'Temp', data: temp, borderColor: 'red', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: 10, max: 40, title: {display:true,text:"Temp (°C)"}}},
                    plugins: { legend: {display: false} }
                }
            });
            // --- dB ---
            if (chart_db) chart_db.destroy();
            chart_db = new Chart(document.getElementById('grafica_db'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'dB', data: db, borderColor: 'orange', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: -90, max: 90, title: {display:true,text:"dB"}}},
                    plugins: { legend: {display: false} }
                }
            });

            // Si son datos fake, borra la tabla (sólo muestra gráficas de prueba)
            if (showFake) tbody.innerHTML = '';
        }
        setInterval(cargarDatos, 3000);
        cargarDatos();
    </script>
</body>
</html>
