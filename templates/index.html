<!DOCTYPE html>
<html>
<head>
    <title>Monitoreo Sensores IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        table { margin-bottom: 30px; }
        .chart-container {
            margin-bottom: 24px;
            width: 350px;
            height: 160px;
            display: inline-block;
            vertical-align: top;
        }
        canvas {
            width: 320px !important;
            height: 120px !important;
        }
        h3 { margin-bottom: 6px; }
    </style>
</head>
<body>
    <h1>Monitoreo Sensores IoT</h1>
    <table border="1" id="tabla">
        <thead>
            <tr>
                <th>Hora</th><th>CO₂</th><th>Velocidad (km/h)</th><th>Temp (°C)</th><th>dB</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="chart-container">
        <h3>CO₂ (ppm)</h3>
        <canvas id="grafica_co2"></canvas>
    </div>
    <div class="chart-container">
        <h3>Velocidad (km/h)</h3>
        <canvas id="grafica_vel"></canvas>
    </div>
    <div class="chart-container">
        <h3>Temp (°C)</h3>
        <canvas id="grafica_temp"></canvas>
    </div>
    <div class="chart-container">
        <h3>dB</h3>
        <canvas id="grafica_db"></canvas>
    </div>

    <script>
        let chart_co2, chart_vel, chart_temp, chart_db;

        async function cargarDatos() {
            const res = await fetch('/ultimos');
            const datos = await res.json();
            const tbody = document.getElementById('tabla').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            let labels = [], co2 = [], velocidad = [], temp = [], db = [];

            datos.reverse().forEach(row => {
                // Formatea cada valor con 2 decimales si es numérico
                let tr = document.createElement('tr');
                row.forEach((d, i) => {
                    let td = document.createElement('td');
                    if (i > 0) {
                        // Solo para columnas numéricas, muestra 2 decimales
                        td.innerText = (typeof d === "number" || !isNaN(Number(d))) ? Number(d).toFixed(2) : d;
                    } else {
                        // Para la hora, pon la hora completa
                        td.innerText = d;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);

                // Hora real HH:MM:SS como label en las gráficas
                labels.push(row[0].split(' ')[1]);
                co2.push(Number(row[1]));
                velocidad.push(Number(row[2]));
                temp.push(Number(row[3]));
                db.push(Number(row[4]));
            });

            // Si NO hay datos reales, muestra datos fake (pero la tabla estará vacía)
            if (labels.length < 2) {
                labels = ["t1","t2","t3","t4"];
                co2 = [400, 405, 410, 402];
                velocidad = [0, 1, 2, 1];
                temp = [21.9, 22.5, 23, 22.8];
                db = [-80, -40, -60, -30];
            }

            // CO₂
            if (chart_co2) chart_co2.destroy();
            chart_co2 = new Chart(document.getElementById('grafica_co2'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'CO₂', data: co2, borderColor: 'green', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: 390, max: 430, title: {display:true,text:"CO₂ (ppm)"}}},
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: ctx => `CO₂: ${ctx.parsed.y.toFixed(2)} ppm`
                            }
                        }
                    }
                }
            });
            // Velocidad
            if (chart_vel) chart_vel.destroy();
            chart_vel = new Chart(document.getElementById('grafica_vel'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'Velocidad', data: velocidad, borderColor: 'blue', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: 0, max: 10, title: {display:true,text:"Velocidad (km/h)"}}},
                    plugins: { legend: {display: false} }
                }
            });
            // Temp
            if (chart_temp) chart_temp.destroy();
            chart_temp = new Chart(document.getElementById('grafica_temp'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'Temp', data: temp, borderColor: 'red', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: 10, max: 40, title: {display:true,text:"Temp (°C)"}}},
                    plugins: { legend: {display: false} }
                }
            });
            // dB
            if (chart_db) chart_db.destroy();
            chart_db = new Chart(document.getElementById('grafica_db'), {
                type: 'line',
                data: { labels: labels, datasets: [{label: 'dB', data: db, borderColor: 'orange', fill: false, pointRadius: 3}] },
                options: {
                    scales: { y: { min: -90, max: 0, title: {display:true,text:"dB"}}},
                    plugins: { legend: {display: false} }
                }
            });
        }
        setInterval(cargarDatos, 3000);
        cargarDatos();
    </script>
</body>
</html>
